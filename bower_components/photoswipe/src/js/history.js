var _historyDefaultOptions={history:!0,galleryUID:1},_historyUpdateTimeout,_hashChangeTimeout,_hashAnimCheckTimeout,_hashChangedByScript,_hashChangedByHistory,_hashReseted,_initialHash,_historyChanged,_closedFromURL,_urlChangedOnce,_windowLoc,_supportsPushState,_getHash=function(){return _windowLoc.hash.substring(1)},_cleanHistoryTimeouts=function(){_historyUpdateTimeout&&clearTimeout(_historyUpdateTimeout),_hashAnimCheckTimeout&&clearTimeout(_hashAnimCheckTimeout)},_parseItemIndexFromURL=function(){var i=_getHash(),t={};if(i.length<5)return t;var e,a=i.split("&");for(e=0;e<a.length;e++)if(a[e]){var n=a[e].split("=");n.length<2||(t[n[0]]=n[1])}if(_options.galleryPIDs){var s=t.pid;for(t.pid=0,e=0;e<_items.length;e++)if(_items[e].pid===s){t.pid=e;break}}else t.pid=parseInt(t.pid,10)-1;return t.pid<0&&(t.pid=0),t},_updateHash=function(){if(_hashAnimCheckTimeout&&clearTimeout(_hashAnimCheckTimeout),_numAnimations||_isDragging)return void(_hashAnimCheckTimeout=setTimeout(_updateHash,500));_hashChangedByScript?clearTimeout(_hashChangeTimeout):_hashChangedByScript=!0;var i=_currentItemIndex+1,t=_getItemAt(_currentItemIndex);t.hasOwnProperty("pid")&&(i=t.pid);var e=_initialHash+"&gid="+_options.galleryUID+"&pid="+i;_historyChanged||-1===_windowLoc.hash.indexOf(e)&&(_urlChangedOnce=!0);var a=_windowLoc.href.split("#")[0]+"#"+e;_supportsPushState?"#"+e!==window.location.hash&&history[_historyChanged?"replaceState":"pushState"]("",document.title,a):_historyChanged?_windowLoc.replace(a):_windowLoc.hash=e,_historyChanged=!0,_hashChangeTimeout=setTimeout(function(){_hashChangedByScript=!1},60)};_registerModule("History",{publicMethods:{initHistory:function(){if(framework.extend(_options,_historyDefaultOptions,!0),_options.history){_windowLoc=window.location,_urlChangedOnce=!1,_closedFromURL=!1,_historyChanged=!1,_initialHash=_getHash(),_supportsPushState="pushState"in history,_initialHash.indexOf("gid=")>-1&&(_initialHash=_initialHash.split("&gid=")[0],_initialHash=_initialHash.split("?gid=")[0]),_listen("afterChange",self.updateURL),_listen("unbindEvents",function(){framework.unbind(window,"hashchange",self.onHashChange)});var i=function(){_hashReseted=!0,_closedFromURL||(_urlChangedOnce?history.back():_initialHash?_windowLoc.hash=_initialHash:_supportsPushState?history.pushState("",document.title,_windowLoc.pathname+_windowLoc.search):_windowLoc.hash=""),_cleanHistoryTimeouts()};_listen("unbindEvents",function(){_closedByScroll&&i()}),_listen("destroy",function(){_hashReseted||i()}),_listen("firstUpdate",function(){_currentItemIndex=_parseItemIndexFromURL().pid});var t=_initialHash.indexOf("pid=");t>-1&&(_initialHash=_initialHash.substring(0,t),"&"===_initialHash.slice(-1)&&(_initialHash=_initialHash.slice(0,-1))),setTimeout(function(){_isOpen&&framework.bind(window,"hashchange",self.onHashChange)},40)}},onHashChange:function(){return _getHash()===_initialHash?(_closedFromURL=!0,void self.close()):void(_hashChangedByScript||(_hashChangedByHistory=!0,self.goTo(_parseItemIndexFromURL().pid),_hashChangedByHistory=!1))},updateURL:function(){_cleanHistoryTimeouts(),_hashChangedByHistory||(_historyChanged?_historyUpdateTimeout=setTimeout(_updateHash,800):_updateHash())}}});